<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>My Library | BookSwap</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- your global site styles -->

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.4.1/dist/css/bootstrap.min.css">
   <link rel="stylesheet" href="/css/style.css">
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark custom-navbar">
  <div class="container-fluid">
    <!-- Logo on far left -->
    <a class="navbar-brand d-flex align-items-center" href="/">
      <span class="logo-icon mr-2" style="display:flex;align-items:center;">
        <!-- Book SVG ICON -->
        <svg width="32" height="32" viewBox="0 0 56 56" fill="none">
          <defs>
            <linearGradient id="navGrad" x1="0" y1="0" x2="56" y2="56" gradientUnits="userSpaceOnUse">
              <stop stop-color="#3BB7FB"/>
              <stop offset="1" stop-color="#F6B443"/>
            </linearGradient>
          </defs>
          <circle cx="28" cy="28" r="28" fill="url(#navGrad)"/>
          <g>
            <rect x="17" y="20" width="10" height="16" rx="2" fill="#fff"/>
            <rect x="29" y="20" width="10" height="16" rx="2" fill="#fff"/>
            <line x1="27.5" y1="20" x2="27.5" y2="36" stroke="#3BB7FB" stroke-width="1.5"/>
          </g>
        </svg>
      </span>
      <span class="logo-text ml-2 gradient-text">Book<span class="swap">Swap</span></span>
    </a>
    
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav"
      aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    
    <div class="collapse navbar-collapse" id="navbarNav">
      <!-- Navigation options in the center with correct order -->
      <!-- Debug: activePage = <%= activePage %> -->
      <ul class="navbar-nav mx-auto">
        <li class="nav-item <%= activePage === 'home' ? 'active' : '' %>" data-page="home">
            <a class="nav-link" href="/"><i class="bi bi-house-door"></i> Home</a>
        </li>
        <li class="nav-item <%= activePage === 'dashboard' ? 'active' : '' %>" data-page="dashboard">
            <a class="nav-link" href="/dashboard"><i class="bi bi-speedometer2"></i> Dashboard</a>
        </li>
        <li class="nav-item <%= activePage === 'library' ? 'active' : '' %>" data-page="library">
            <a class="nav-link" href="/library"><i class="bi bi-book"></i> My Library</a>
        </li>
        <li class="nav-item <%= activePage === 'wishlist' ? 'active' : '' %>" data-page="wishlist">
            <a class="nav-link" href="/wishlist"><i class="bi bi-heart"></i> Wishlist</a>
        </li>
        <li class="nav-item <%= activePage === 'swap-matcher' ? 'active' : '' %>" data-page="swap-matcher">
            <a class="nav-link" href="/swap-matcher"><i class="bi bi-arrow-left-right"></i> Swap Matcher</a>
        </li>
        <li class="nav-item <%= activePage === 'nearby' ? 'active' : '' %>" data-page="nearby">
            <a class="nav-link" href="/nearby"><i class="bi bi-geo-alt"></i> Nearby</a>
        </li>
        <li class="nav-item <%= activePage === 'rewards' ? 'active' : '' %>" data-page="rewards">
            <a class="nav-link" href="/rewards"><i class="bi bi-trophy"></i> Rewards</a>
        </li>
      </ul>
      
      <!-- Profile dropdown on far right -->
      <ul class="navbar-nav ml-auto">
        <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="profileDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                <i class="bi bi-person-circle"></i> Profile
            </a>
            <div class="dropdown-menu dropdown-menu-right" aria-labelledby="profileDropdown">
                <a class="dropdown-item" href="/me"><i class="bi bi-person"></i> My Profile</a>
                <a class="dropdown-item" href="/logout"><i class="bi bi-box-arrow-right"></i> Logout</a>
            </div>
        </li>
      </ul>
    </div>
  </div>
</nav>

  <main class="container mt-5">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <div>
        <h1 class="mb-0 page-title">
          My Library
          <span class="title-icon">
            <img src="/images/image.png" alt="Library Icon" class="title-icon-img" />
          </span>
        </h1>
        <div class="subtitle">Manage your book collection and share with fellow readers</div>
      </div>

      <!-- keep href exactly as before; JS below prevents navigation and opens modal -->
      <a href="/add-book" class="btn btn-gradient header-add-btn">
        <i class="bi bi-plus"></i> Add Book
      </a>
    </div>

    <!-- Search bar -->
<div class="search-wrap mb-4">
  <div class="search-box">
    <span class="search-icon"><i class="bi bi-search"></i></span>
    <input
      id="library-search"
      type="text"
      class="form-control search-input"
      placeholder="Search your library..."
      autocomplete="off"
    />
  </div>
</div>

    <!-- Books Grid / Empty State -->
    <div id="library-content" data-books='<%- JSON.stringify(books || []) %>'>
      <% if (!books || books.length === 0) { %>
        <div id="empty-state" class="text-center my-5">
          <i class="bi bi-book empty-state-icon"></i>
          <h4 class="mt-3 empty-title">Your library is empty</h4>
          <div class="empty-text">Start building your collection by adding your first book!</div>
          <a href="/add-book" class="btn btn-gradient mt-3 first-book-btn">
            <i class="bi bi-plus"></i> Add Your First Book
          </a>
        </div>
      <% } %>

      <div id="books-grid" class="row">
        <% if (books && books.length) { %>
          <% books.forEach(function(book){ %>
            <div class="col-6 col-sm-4 col-md-3 mb-4 book-card"
                 data-title="<%= (book.title||'').toLowerCase() %>"
                 data-author="<%= (book.author||'').toLowerCase() %>">
              <div class="card h-100 card-dark">
                <img src="<%= book.image || '/images/book-placeholder.png' %>" class="card-img-top card-cover" alt="<%= book.title %>">
                <div class="card-body card-body-compact">
                  <h6 class="card-title card-title-white"><%= book.title %></h6>
                  <div class="author-text"><%= book.author %></div>
                  <div class="d-flex justify-content-between align-items-center">
                    <small class="text-muted text-muted-light">Condition: <%= book.condition || 'N/A' %></small>
                    <a href="/books/<%= book.id %>" class="btn btn-sm btn-outline-light">Details</a>
                  </div>
                </div>
              </div>
            </div>
          <% }) %>
        <% } %>
      </div>
    </div>

    <!-- Library Statistics (same structure/cols as your original) -->
<div class="mt-5 stats-container">
  <div class="p-4 stats-inner">
    <div class="stats-title text-center mb-3">Library Statistics</div>
    <div class="row text-center">
      <div class="col-12 col-md-3 mb-3">
        <div id="stat-total" class="stat-value"><%= (books && books.length) ? books.length : 0 %></div>
        <div class="stat-label">Total Books</div>
      </div>
      <div class="col-12 col-md-3 mb-3">
        <div id="stat-available" class="stat-value">0</div>
        <div class="stat-label">Available</div>
      </div>
      <div class="col-12 col-md-3 mb-3">
        <div id="stat-authors" class="stat-value">0</div>
        <div class="stat-label">Authors</div>
      </div>
      <div class="col-12 col-md-3 mb-3">
        <div id="stat-excellent" class="stat-value">0</div>
        <div class="stat-label">Excellent Condition</div>
      </div>
    </div>
  </div>
</div>
  </main>

  <!-- Add Book Modal -->
  <div class="modal fade" id="addBookModal" tabindex="-1" role="dialog" aria-labelledby="addBookModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
      <div class="modal-content modal-dark">
        <div class="modal-header modal-header-no-border">
          <h4 class="modal-title font-weight-bold" id="addBookModalLabel">Add Your Book</h4>
          <button type="button" class="close modal-close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <form id="add-book-form">
          <div class="modal-body">
            <div class="form-row">
              <div class="form-group col-md-7">
                <label for="book-title">Book Title</label>
                <input type="text" id="book-title" class="form-control input-dark" placeholder="Book Title" name="title">
              </div>
              <div class="form-group col-md-5 d-flex flex-column align-items-center justify-content-center">
                <label class="w-100 text-center">&nbsp;</label>
                <div class="upload-drop">
                  <i class="bi bi-image upload-icon"></i>
                  <div class="upload-text">Upload<br>cover image</div>
                  <input type="file" accept="image/*" class="upload-input" name="cover" id="book-cover">
                </div>
              </div>
            </div>

            <div class="form-row">
              <div class="form-group col-md-6">
                <label for="book-author">Author</label>
                <input type="text" class="form-control input-dark" placeholder="Author" name="author" id="book-author">
              </div>
              <div class="form-group col-md-3">
                <label for="book-genre">Genre</label>
                <select class="form-control select-dark" name="genre" id="book-genre">
                  <option disabled selected>Genre</option>
                  <option>Fiction</option>
                  <option>Non-fiction</option>
                  <option>Science</option>
                  <option>History</option>
                  <option>Biography</option>
                  <option>Other</option>
                </select>
              </div>
              <div class="form-group col-md-3">
                <label for="book-language">Language</label>
                <select class="form-control select-dark" name="language" id="book-language">
                  <option disabled selected>Language</option>
                  <option>English</option>
                  <option>Arabic</option>
                  <option>French</option>
                  <option>Spanish</option>
                  <option>Other</option>
                </select>
              </div>
            </div>

            <div class="form-row">
              <div class="form-group col-md-4">
                <label for="book-year">Publication Year</label>
                <input type="number" class="form-control input-dark" placeholder="Year" name="year" id="book-year" min="1450" max="<%= new Date().getFullYear() %>">
              </div>
              <div class="form-group col-md-4">
                <label for="book-isbn">ISBN</label>
                <input type="text" class="form-control input-dark" placeholder="ISBN" name="isbn" id="book-isbn">
              </div>
              <div class="form-group col-md-4">
                <label for="book-publisher">Publisher</label>
                <input type="text" class="form-control input-dark" placeholder="Publisher" name="publisher" id="book-publisher">
              </div>
            </div>

            <div class="form-row">
              <div class="form-group col-md-6">
                <label>Condition</label>
                <div class="d-flex flex-column condition-stack">
                  <div class="form-check d-flex align-items-center">
                    <input class="form-check-input" type="radio" name="condition" id="condNew" value="New" checked>
                    <label class="form-check-label ml-2" for="condNew">New</label>
                    <span class="ml-2 condition-emoji">üòÄ</span>
                  </div>
                  <div class="form-check d-flex align-items-center">
                    <input class="form-check-input" type="radio" name="condition" id="condExcellent" value="Excellent">
                    <label class="form-check-label ml-2" for="condExcellent">Excellent</label>
                    <span class="ml-2 condition-emoji">üôÇ</span>
                  </div>
                  <div class="form-check d-flex align-items-center">
                    <input class="form-check-input" type="radio" name="condition" id="condGood" value="Good">
                    <label class="form-check-label ml-2" for="condGood">Good</label>
                    <span class="ml-2 condition-emoji">üòê</span>
                  </div>
                  <div class="form-check d-flex align-items-center">
                    <input class="form-check-input" type="radio" name="condition" id="condFair" value="Fair">
                    <label class="form-check-label ml-2" for="condFair">Fair</label>
                    <span class="ml-2 condition-emoji">üôÅ</span>
                  </div>
                  <div class="form-check d-flex align-items-center">
                    <input class="form-check-input" type="radio" name="condition" id="condPoor" value="Poor">
                    <label class="form-check-label ml-2" for="condPoor">Poor</label>
                    <span class="ml-2 condition-emoji">üò¢</span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="modal-footer modal-footer-no-border">
            <button type="button" class="btn btn-secondary btn-cancel" data-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary btn-submit">Add Book</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- YOUR ORIGINAL JS FOR MODAL TRIGGER (unchanged) -->
  <script>
    // Pass server-side books to client for search/filtering via data attribute
    window.initialBooks = (function(){
      try {
        var raw = document.getElementById('library-content').dataset.books || '[]';
        return JSON.parse(raw);
      } catch (e) {
        return [];
      }
    })();

    function renderBooks(bookList) {
      const grid = document.getElementById('books-grid');
      const empty = document.getElementById('empty-state');
      grid.innerHTML = '';
      if (!bookList || bookList.length === 0) {
        if (empty) empty.style.display = 'block';
        return;
      }
      if (empty) empty.style.display = 'none';

      bookList.forEach(function(book){
        const col = document.createElement('div');
        col.className = 'col-6 col-sm-4 col-md-3 mb-4 book-card';
        col.setAttribute('data-title', (book.title || '').toLowerCase());
        col.setAttribute('data-author', (book.author || '').toLowerCase());

        const card = document.createElement('div');
        card.className = 'card h-100 card-dark';

        const img = document.createElement('img');
        img.className = 'card-img-top card-cover';
        img.alt = book.title || '';
        img.src = book.image || '/images/book-placeholder.png';

        const body = document.createElement('div');
        body.className = 'card-body card-body-compact';

        const h6 = document.createElement('h6');
        h6.className = 'card-title card-title-white';
        h6.textContent = book.title || 'Untitled';

        const author = document.createElement('div');
        author.className = 'author-text';
        author.textContent = book.author || 'Unknown';

        const footer = document.createElement('div');
        footer.className = 'd-flex justify-content-between align-items-center';

        const cond = document.createElement('small');
        cond.className = 'text-muted text-muted-light';
        cond.textContent = 'Condition: ' + (book.condition || 'N/A');

        const details = document.createElement('a');
        details.className = 'btn btn-sm btn-outline-light';
        details.href = '/books/' + (book.id || '');
        details.textContent = 'Details';

        footer.appendChild(cond);
        footer.appendChild(details);
        body.appendChild(h6);
        body.appendChild(author);
        body.appendChild(footer);

        card.appendChild(img);
        card.appendChild(body);
        col.appendChild(card);
        grid.appendChild(col);
      });

      // update simple stats
      const total = bookList.length;
      document.getElementById('stat-total').textContent = total;
      const available = bookList.filter(b => b.available === true).length;
      document.getElementById('stat-available').textContent = available;
      const authors = Array.from(new Set(bookList.map(b => b.author).filter(Boolean))).length;
      document.getElementById('stat-authors').textContent = authors;
      const excellent = bookList.filter(b => (b.condition||'').toLowerCase() === 'excellent').length;
      document.getElementById('stat-excellent').textContent = excellent;
    }

    // initial render + search
    document.addEventListener('DOMContentLoaded', function(){
      renderBooks(window.initialBooks);

      const input = document.getElementById('library-search');
      input.addEventListener('input', function(){
        const q = this.value.trim().toLowerCase();
        if (!q) { renderBooks(window.initialBooks); return; }
        const filtered = window.initialBooks.filter(b => {
          const title = (b.title||'').toLowerCase();
          const author = (b.author||'').toLowerCase();
          return title.includes(q) || author.includes(q);
        });
        renderBooks(filtered);
      });
    });

    // Add Book modal trigger (ORIGINAL)
    document.addEventListener('DOMContentLoaded', function(){
      function showAddBookModal(e){
        e.preventDefault();
        $('#addBookModal').modal('show');
      }
      var addBookBtn = document.querySelector('a.btn-gradient[href="/add-book"]');
      if(addBookBtn) addBookBtn.addEventListener('click', showAddBookModal);
      var firstBookBtn = document.querySelector('a.btn-gradient.mt-3');
      if(firstBookBtn) firstBookBtn.addEventListener('click', showAddBookModal);
    });
  </script>


<script>
document.addEventListener('DOMContentLoaded', function() {
  const addBookForm = document.getElementById('add-book-form');
  addBookForm.addEventListener('submit', async function(e) {
    e.preventDefault();
    const formData = new FormData(addBookForm);
    const payload = Object.fromEntries(formData.entries());

    const res = await fetch('/books', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    const json = await res.json();
    if (json.ok) {
      location.reload();
    } else {
      alert(json.message || 'Failed to add book');
    }
  });
});
</script>
  <!-- emoji opacity handlers (unchanged logic) -->
  <script>
    document.querySelectorAll('input[name="condition"]').forEach(function(radio){
      radio.addEventListener('change', function(){
        document.querySelectorAll('.condition-emoji').forEach(function(emoji){ emoji.style.opacity = '0.5'; });
        var selected = this.parentElement.querySelector('.condition-emoji');
        if(selected) selected.style.opacity = '1';
      });
    });
  </script>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.4.1/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
